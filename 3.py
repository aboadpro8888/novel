import requests
from bs4 import BeautifulSoup
import time
import urllib.parse
import random
import os
import re

# --- الإعدادات ---
BASE_URL = "https://ar-no.com/novel/%d8%ac%d9%8a%d9%86%d8%a7%d8%aa-%d8%a7%d9%84%d8%a5%d9%84%d9%87-%d8%a7%d9%84%d8%ae%d8%a7%d8%b1%d9%82%d8%a9/01-1-1000/"
HEADERS = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"}
TXT_OUTPUT = "Super_Gene_V4.txt"
HTML_OUTPUT = "Super_Gene_V4.html"

# القائمة المدمجة (321 - 640)
raw_chapters_text = """
640
639
638
637
636
635
634
633
632
631
630
629
628
627
626
625
624
623
622
621
620
619
618
617
616
615
614
613
612
611
610
609
608
607
606
605
604
603
602
601
600
599
598
597
596
595
594
593
592
591
590
589
588
587
586
585
584
583
582
581
580
579
578
577
576
575
574
573
572
571
570
569
568
567
566
565
564
563
562
561
560
559
558
557
556
555
554
553
552
551
550
549
548
547
546
545
544
543
542
541
540
539
538
537
536
535
534
533
532
531
530 - توأم
529 - قتال الفتاة الروح ذات الشعر الفضي
528 - دخول الملاذ وحيدا
527 - الخنافس الفضية
526 - روح وحش الكابوس
525 - فهم جديد
524 - دراسة اللغة القديمة
523 - ربح عظيم
522 - سرقة الروح
521 - كنوز البحر
520 - قتل السرطان الذهبي
519 - الصيد في قاع البحيرة
518 - التنمر على أني
517 - عار كل الجنود
516 - قتل بضربة واحدة
515 - سيكون دولار أفضل
514 - سرقة
513 - ملك الثعابين السمكية
512 - تانغ تشن ليو المستاء
511 - حل المعضلة
510 - سكين الإعصار
509 - القصر البلوري
508 - صندوق الكنز البلوري
507 - السرطان الذهبي
506 - القتال تحت الماء
505 - الإله الأسود
504 - السمكة الزرقاء
503 - إشتراء أرواح الوحوش
502 - الحارس الأخر
501 - ملك جنود الجنوب الغربي
500 - لقد خسرت بالفعل
499 - القتال لكي يصبح ملك جنود
498 - سحر جندي
497 - نمر الدم الأزرق الشرس
496 - إختبار القوة
495 - الملاذ الملكي
494 - عمل البلورة السوداء
493 - دولار ينتشر
492 - غضب
491 - شفرات القمر
490 - لقد عاد الملك
489 - أقتل دولار
488 - المنصة الرسمية
487 - التمثال الهائج
486 - الفراشة ترقص وحدها
485 - أمل وسط اليأس
484 - روح ملكية
483 - النمس ذو المخالب الشبحية
482 - النمس الأرجواني
481 - مدرب
480 - كبير جيش
479 - أحرك الأشياء بذهني
478
477 - السيف المتسلسل
476 - البلورة الحمراء
475 - مفتاح المبلورين
474 - الكفاءة
473 - طريق مغلقة
472 - الكنز
471 - خنفساء أحادية القرن
470 - مكعب روبيك ذهبي
469 - الصورة على البطاقات البلورية
468 - المنطقة المركزية
467 - مجرة ديا
466 - البلورات الطفيلية
465 - بلورات المحاكاة المجنونة
464 - بلورات المحاكاة
463 - أنقاض المبلورين
462 - ساحرة الثلج
461 - الروح تظهر الولاء
460 - حجر الروح
459 - ملاذ غريب
458 - مهاجمة ملاذ الروح
457 - لجنة الخبراء
456 - تمثال
455 - التحرك على الغيوم
454 - خذني معك
453 - قتل مخلوق متحول
452 - عصابة الإلهة
451 - أول إختراق
450 - إختيار فن جين مفرط
449 - مثل الدليل
448 - مجند جديد يجرب التسارع
447 - مكافأة
446 - مصدومين
445 - جبل من اللحم
444 - إنتهاء تطور الملاك
443 - يتقاتل إثنان يربح الثالث من ذلك
442 - روح أرستقراطية
441 - تحت الجرف الجليدي
440 - قتال مخلوق دم مقدس
439 - عنكبوت الثلج
438 - واقع قاسي
437 - هائج
436 - أول صيد
435 - مجرد إمرأة
434 - رؤية حبيبتي مجددا
433 - المبلورين
432 - الركلة الثامنة المستحيلة
431 - مرة أخرى
430 - شرس
429 - شخصٌ مثلِ
428 - الركلات القاتلة
427 - شهادة أرستقراطي
426 - إخفاء الجميلة
425 - معبد الإله الثاني
424 - غير مريح في الذهن
423 - الكريستالة السوداء
422 - التطور
421 - أكبر مشكلة
420 - التحضيرات قبل التطور
419 - طائر النار مجددا
418 - وشم
417 - فتاة مضطربة عقليا
416 - ثروة
415 - بشري؟
414 - مجنونة؟
413 - إمرأة غريبة
412 - حقيبة خليط معدني في الكهف
411 - قتل ملك العفاريت
410 - العفاريت الشريرة
409 - غير مهتم
408 - نصف إله القبضة الحديدية
407 - دافني
406 - تعيين خاصة
405 - قوة الملاك
404 - الأيام الأولى
403 - قطة الحياة التاسعة
402 - أختار أن أقتل
401 - رقم 107
400 - مطوق
399 - مزاد مجنون
398 - سوترا دونغ شوان
397 - إكتشاف صادم
396 - تحرش به حيوان أليف
395 - لحم خارق
394 - عرض منفرد
393
392 - شخص ميت غريب
391 - درع الحيوان الأليف الذي لا يقهر
390 - قتل مخلوق دم مقدس لم تراه حتى
389 - الخطة لإتمام الجينات المقدسة
388 - روح وحش درع حيوان أليف
387 - روح وحش حلزون الدم
386 - من المتحكم
385 - مخلوق غريب
384 - سيد كيغونغ؟
383 - أول رجال في معبد الإله الأول
382 - روح وحش الدم المقدس للسمكة العظمية
381 - الخدمة السرية
380 - بعد أن أضربك
379 - عطر مميت
378 - التحول
377 - الحلزون العملاق
376 - غابة بدائية
375 - تخمين هان سين
374 - قطع حلق
373 - شيطان
372 - نينغ يوي
371 - مستأجر للقتال
370 - روح وحش إضافة
369 - طلب نجدة
368 - روح وحش خارقة أخرى
367 - العودة من الموت
366 - القتال وحيدا
365 - كعب أخيل
364 - المحاولة مرة أخرى
363 - الخطة
362 - معركة دموية
361 - ذئب المعدن
360 - مخلوق خارق في العش
359 - الإنحرافات السبعة
358 - عش أخر
357 - المرة الثانية لجبال تنين اليشم
356 - الجينات الخارقة؟
355 - الأشياء المتروكة من قبل الموتى
354 - التسارع
353 - طائر النار
352 - سيف لحياة
351 - ليس كل المتطورين جيدين
350 - متطورون في معبد الإله الأول
349 - مخلوق كالعنقاء
348 - يعطي شعورا كالملكة
347 - غير جدير كعدو
346 - لاعب الـGO وحجر
345 - تعامل خطير
344 - هل هو مزروع؟
343 - البراءة البدائية
342 - إختبار
341 - تجارة عبر الحدود
340 - أرواح وحوش ملاذ الإله الثاني
339 - روح وحش القاطع المائي
338 - الفرصة الوحيدة
337 - حرب المخلوقات
336 - مخلوق مجنون
335 - إتبعوا السلحفاة
334 - النهر تحت الأرض
333 - شيطان النحاس
332 - لعب الـGO
331 - التفادي
330 - قتال السلحفاة
329 - السلحفاة مجددا
328 - علم النبات
327 - البطل المطلق
326 - زميل تمرين
325 - التجهيز
324 - قتال الملكة
323 - دعوة من الملكة
322 - غشاشين
321 - الإجهاد
"""

def clean_slug(text):
    text = re.sub(r"[؟?()!.'،,]", "", text)
    text = text.strip().replace(" ", "-")
    return re.sub(r'-+', '-', text)

def get_content(url):
    try:
        r = requests.get(url, headers=HEADERS, timeout=10)
        if r.status_code == 200:
            soup = BeautifulSoup(r.content, "html.parser")
            div = soup.find("div", class_="text-left")
            if div: return div.get_text(separator="\n").strip()
    except: pass
    return None

def start():
    lines = [l.strip() for l in raw_chapters_text.strip().split("\n") if l.strip()]
    lines.reverse() # من 321 إلى 640
    
    print(f"[*] سحب {len(lines)} فصلاً مع معالجة الروابط الرقمية...")
    
    with open(TXT_OUTPUT, "w", encoding="utf-8") as f:
        for line in lines:
            print(f"[*] جاري العمل على: {line}")
            
            # استخراج الرقم
            chapter_num = line.split(" - ")[0].strip()
            
            # محاولات الرابط الذكية
            urls_to_try = []
            
            # 1. إذا كان السطر يحتوي على عنوان، جرب رابط العنوان
            if " - " in line:
                title = line.split(" - ")[1].strip()
                urls_to_try.append(f"{BASE_URL}{chapter_num}-{clean_slug(title)}/")
            
            # 2. جرب الرابط الرقمي الصرف (مثل 531/)
            urls_to_try.append(f"{BASE_URL}{chapter_num}/")
            
            # 3. جرب "الفصل-الرقم"
            urls_to_try.append(f"{BASE_URL}%d8%a7%d9%84%d9%81%d8%b5%d9%84-{chapter_num}/")

            content = None
            for target_url in urls_to_try:
                content = get_content(target_url)
                if content: break
            
            if content:
                f.write(f"\n\n{'='*20}\n{line}\n{'='*20}\n\n{content}")
                f.flush()
                print(f"    [V] نجح السحب")
            else:
                print(f"    [X] فشل السحب لكل المحاولات")
            
            time.sleep(random.uniform(0.8, 1.2))

    convert_to_html()

def convert_to_html():
    if not os.path.exists(TXT_OUTPUT): return
    with open(TXT_OUTPUT, "r", encoding="utf-8") as f: content = f.read()
    chapters = content.split("====================")
    html_header = f"<!DOCTYPE html><html dir='rtl' lang='ar'><head><meta charset='UTF-8'><title>Super Gene 321-640</title><style>body{{font-family:'Segoe UI';padding:20px;line-height:1.8;background:#f4f7f6;max-width:850px;margin:auto;}}.chapter-card{{background:#fff;padding:30px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);white-space:pre-wrap;}}h1{{color:#2c3e50;border-bottom:3px solid #e67e22;}}</style></head><body>"
    html_body = ""
    for i in range(1, len(chapters), 2):
        title = chapters[i].strip()
        body = chapters[i+1].strip() if (i+1) < len(chapters) else ""
        html_body += f"<div class='chapter-card'><h1>{title}</h1>{body}</div>"
    with open(HTML_OUTPUT, "w", encoding="utf-8") as hf: hf.write(html_header + html_body + "</body></html>")

if __name__ == "__main__":
    start()
